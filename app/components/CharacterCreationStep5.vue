<template>
  <div class="character-creation-step">
    <div class="text-center mb-8">
      <h2 class="text-3xl font-bold text-amber-800 mb-2">ğŸ¨ æœ€çµ‚ä¿®é£¾</h2>
      <p class="text-gray-600 text-lg">
        å®Œå–„ä½ çš„è§’è‰²ï¼Œè¨ˆç®—æœ€çµ‚æ•¸å€¼ï¼Œä¸¦ç‚ºè§’è‰²è³¦äºˆç”Ÿå‘½ã€‚
      </p>
    </div>

    <!-- å„æ­¥é©Ÿè©³ç´°åˆ†æ -->
    <div class="mb-8">
      <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“‹ å„æ­¥é©Ÿè©³ç´°åˆ†æ</h3>
      
      <div class="space-y-6">
        <!-- æ­¥é©Ÿ1ï¼šåŸå‹ -->
        <div class="bg-white border border-gray-200 rounded-lg p-6">
          <div class="flex items-center gap-2 mb-4">
            <span class="text-2xl">ğŸ­</span>
            <h4 class="text-lg font-bold text-blue-600">æ­¥é©Ÿ1ï¼šåŸå‹</h4>
            <span v-if="characterCreationState.selectedArchetype" class="text-green-600 font-bold">âœ“</span>
            <span v-else class="text-red-600 font-bold">âœ— æœªé¸æ“‡</span>
          </div>
          <div v-if="characterCreationState.selectedArchetype" class="space-y-3">
            <div class="bg-blue-50 p-3 rounded-lg">
              <span class="font-bold text-blue-800">{{ characterCreationState.selectedArchetype.name }}</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="bg-green-50 p-3 rounded-lg">
                <div class="text-sm text-gray-600 mb-1">æä¾›çš„å¤©è³¦</div>
                <div class="font-bold text-green-800">{{ archetypeContribution.talents.length }} å€‹</div>
                <div v-if="archetypeContribution.talents.length > 0" class="text-xs text-green-600 mt-1">
                  {{ archetypeContribution.talents.join('ã€') }}
                </div>
              </div>
              <div class="bg-amber-50 p-3 rounded-lg">
                <div class="text-sm text-gray-600 mb-1">æä¾›çš„å°ˆç²¾</div>
                <div class="font-bold text-amber-800">{{ archetypeContribution.focuses.length }} å€‹</div>
                <div v-if="archetypeContribution.focuses.length > 0" class="text-xs text-amber-600 mt-1">
                  {{ archetypeContribution.focuses.join('ã€') }}
                </div>
              </div>
            </div>
          </div>
          <div v-else class="text-red-600 bg-red-50 p-3 rounded-lg">
            âš ï¸ è«‹å›åˆ°æ­¥é©Ÿ1é¸æ“‡åŸå‹
          </div>
        </div>

        <!-- æ­¥é©Ÿ2ï¼šåœ‹ç± -->
        <div class="bg-white border border-gray-200 rounded-lg p-6">
          <div class="flex items-center gap-2 mb-4">
            <span class="text-2xl">ğŸŒ</span>
            <h4 class="text-lg font-bold text-purple-600">æ­¥é©Ÿ2ï¼šåœ‹ç±</h4>
            <span v-if="characterCreationState.selectedNationality" class="text-green-600 font-bold">âœ“</span>
            <span v-else class="text-red-600 font-bold">âœ— æœªé¸æ“‡</span>
          </div>
          <div v-if="characterCreationState.selectedNationality" class="space-y-3">
            <div class="bg-purple-50 p-3 rounded-lg">
              <span class="font-bold text-purple-800">{{ characterCreationState.selectedNationality.name }}</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div class="bg-green-50 p-3 rounded-lg">
                <div class="text-sm text-gray-600 mb-1">æä¾›çš„çœŸç†</div>
                <div class="font-bold text-green-800">{{ nationalityContribution.truths.length }} å€‹</div>
                <div v-if="nationalityContribution.truths.length > 0" class="text-xs text-green-600 mt-1">
                  {{ nationalityContribution.truths.join('ã€') }}
                </div>
              </div>
              <div class="bg-blue-50 p-3 rounded-lg">
                <div class="text-sm text-gray-600 mb-1">å±¬æ€§åŠ å€¼</div>
                <div class="font-bold text-blue-800">{{ nationalityContribution.attributes.length }} é …</div>
                <div v-if="nationalityContribution.attributes.length > 0" class="text-xs text-blue-600 mt-1">
                  {{ nationalityContribution.attributes.join('ã€') }}
                </div>
              </div>
              <div class="bg-orange-50 p-3 rounded-lg">
                <div class="text-sm text-gray-600 mb-1">æŠ€èƒ½åŠ å€¼</div>
                <div class="font-bold text-orange-800">{{ nationalityContribution.skills.length }} é …</div>
                <div v-if="nationalityContribution.skills.length > 0" class="text-xs text-orange-600 mt-1">
                  {{ nationalityContribution.skills.join('ã€') }}
                </div>
              </div>
              <div class="bg-pink-50 p-3 rounded-lg">
                <div class="text-sm text-gray-600 mb-1">èªè¨€</div>
                <div class="font-bold text-pink-800">{{ nationalityContribution.languages.length }} ç¨®</div>
                <div v-if="nationalityContribution.languages.length > 0" class="text-xs text-pink-600 mt-1">
                  {{ nationalityContribution.languages.join('ã€') }}
                </div>
              </div>
            </div>
          </div>
          <div v-else class="text-red-600 bg-red-50 p-3 rounded-lg">
            âš ï¸ è«‹å›åˆ°æ­¥é©Ÿ2é¸æ“‡åœ‹ç±
          </div>
        </div>

        <!-- æ­¥é©Ÿ3ï¼šèƒŒæ™¯ -->
        <div class="bg-white border border-gray-200 rounded-lg p-6">
          <div class="flex items-center gap-2 mb-4">
            <span class="text-2xl">ğŸ’</span>
            <h4 class="text-lg font-bold text-indigo-600">æ­¥é©Ÿ3ï¼šèƒŒæ™¯</h4>
            <span v-if="characterCreationState.selectedBackground" class="text-green-600 font-bold">âœ“</span>
            <span v-else class="text-red-600 font-bold">âœ— æœªé¸æ“‡</span>
          </div>
          <div v-if="characterCreationState.selectedBackground" class="space-y-3">
            <div class="bg-indigo-50 p-3 rounded-lg">
              <span class="font-bold text-indigo-800">{{ characterCreationState.selectedBackground.name }}</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div class="bg-green-50 p-3 rounded-lg">
                <div class="text-sm text-gray-600 mb-1">æä¾›çš„çœŸç†</div>
                <div class="font-bold text-green-800">{{ backgroundContribution.truths.length }} å€‹</div>
                <div v-if="backgroundContribution.truths.length > 0" class="text-xs text-green-600 mt-1">
                  {{ backgroundContribution.truths.join('ã€') }}
                </div>
              </div>
              <div class="bg-amber-50 p-3 rounded-lg">
                <div class="text-sm text-gray-600 mb-1">æä¾›çš„å°ˆç²¾</div>
                <div class="font-bold text-amber-800">{{ backgroundContribution.focuses.length }} å€‹</div>
                <div v-if="backgroundContribution.focuses.length > 0" class="text-xs text-amber-600 mt-1">
                  {{ backgroundContribution.focuses.join('ã€') }}
                </div>
              </div>
              <div class="bg-pink-50 p-3 rounded-lg">
                <div class="text-sm text-gray-600 mb-1">æä¾›çš„å¤©è³¦</div>
                <div class="font-bold text-pink-800">{{ backgroundContribution.talents.length }} å€‹</div>
                <div v-if="backgroundContribution.talents.length > 0" class="text-xs text-pink-600 mt-1">
                  {{ backgroundContribution.talents.join('ã€') }}
                </div>
              </div>
              <div class="bg-cyan-50 p-3 rounded-lg">
                <div class="text-sm text-gray-600 mb-1">é¡å¤–é¸æ“‡</div>
                <div class="font-bold text-cyan-800">
                  {{ (backgroundContribution.attributes.length + backgroundContribution.skills.length) }} é …
                </div>
                <div v-if="backgroundContribution.attributes.length > 0 || backgroundContribution.skills.length > 0" class="text-xs text-cyan-600 mt-1">
                  {{ [...backgroundContribution.attributes, ...backgroundContribution.skills].join('ã€') }}
                </div>
              </div>
            </div>
          </div>
          <div v-else class="text-red-600 bg-red-50 p-3 rounded-lg">
            âš ï¸ è«‹å›åˆ°æ­¥é©Ÿ3é¸æ“‡èƒŒæ™¯
          </div>
        </div>

        <!-- æ­¥é©Ÿ4ï¼šç‰¹å¾µ -->
        <div class="bg-white border border-gray-200 rounded-lg p-6">
          <div class="flex items-center gap-2 mb-4">
            <span class="text-2xl">â­</span>
            <h4 class="text-lg font-bold text-teal-600">æ­¥é©Ÿ4ï¼šç‰¹å¾µ</h4>
            <span v-if="characterCreationState.selectedTrait" class="text-green-600 font-bold">âœ“</span>
            <span v-else class="text-red-600 font-bold">âœ— æœªé¸æ“‡</span>
          </div>
          <div v-if="characterCreationState.selectedTrait" class="space-y-3">
            <div class="bg-teal-50 p-3 rounded-lg">
              <span class="font-bold text-teal-800">{{ characterCreationState.selectedTrait.name }}</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div class="bg-green-50 p-3 rounded-lg">
                <div class="text-sm text-gray-600 mb-1">æä¾›çš„çœŸç†</div>
                <div class="font-bold text-green-800">{{ traitContribution.truths.length }} å€‹</div>
                <div v-if="traitContribution.truths.length > 0" class="text-xs text-green-600 mt-1">
                  {{ traitContribution.truths.join('ã€') }}
                </div>
              </div>
              <div class="bg-amber-50 p-3 rounded-lg">
                <div class="text-sm text-gray-600 mb-1">æä¾›çš„å°ˆç²¾</div>
                <div class="font-bold text-amber-800">{{ traitContribution.focuses.length }} å€‹</div>
                <div v-if="traitContribution.focuses.length > 0" class="text-xs text-amber-600 mt-1">
                  {{ traitContribution.focuses.join('ã€') }}
                </div>
              </div>
              <div class="bg-pink-50 p-3 rounded-lg">
                <div class="text-sm text-gray-600 mb-1">æä¾›çš„å¤©è³¦</div>
                <div class="font-bold text-pink-800">{{ traitContribution.talents.length }} å€‹</div>
                <div v-if="traitContribution.talents.length > 0" class="text-xs text-pink-600 mt-1">
                  {{ traitContribution.talents.join('ã€') }}
                </div>
              </div>
              <div class="bg-cyan-50 p-3 rounded-lg">
                <div class="text-sm text-gray-600 mb-1">é¡å¤–é¸æ“‡</div>
                <div class="font-bold text-cyan-800">
                  {{ (traitContribution.attributes.length + traitContribution.skills.length) }} é …
                </div>
                <div v-if="traitContribution.attributes.length > 0 || traitContribution.skills.length > 0" class="text-xs text-cyan-600 mt-1">
                  {{ [...traitContribution.attributes, ...traitContribution.skills].join('ã€') }}
                </div>
              </div>
            </div>
          </div>
          <div v-else class="text-red-600 bg-red-50 p-3 rounded-lg">
            âš ï¸ è«‹å›åˆ°æ­¥é©Ÿ4é¸æ“‡ç‰¹å¾µ
          </div>
        </div>
      </div>
    </div>

    <!-- æ•¸å€¼æª¢æŸ¥å€åŸŸ -->
    <div class="mb-8">
      <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“Š æœ€çµ‚æ•¸å€¼æª¢æŸ¥</h3>
      
      <!-- æ­¥é©Ÿå®Œæˆç‹€æ…‹æ¦‚è¦½ -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <!-- å„æ­¥é©Ÿå®Œæˆç‹€æ…‹ -->
        <div :class="characterCreationState.selectedArchetype ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'" 
             class="p-3 rounded-lg border-2">
          <div class="flex items-center justify-between mb-1">
            <span class="text-sm font-medium">æ­¥é©Ÿ1ï¼šåŸå‹</span>
            <span :class="characterCreationState.selectedArchetype ? 'text-green-500' : 'text-red-500'">
              {{ characterCreationState.selectedArchetype ? 'âœ“' : 'âœ—' }}
            </span>
          </div>
          <div class="text-xs text-gray-600">
            {{ characterCreationState.selectedArchetype ? characterCreationState.selectedArchetype.name : 'æœªé¸æ“‡åŸå‹' }}
          </div>
        </div>
        
        <div :class="characterCreationState.selectedNationality ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'" 
             class="p-3 rounded-lg border-2">
          <div class="flex items-center justify-between mb-1">
            <span class="text-sm font-medium">æ­¥é©Ÿ2ï¼šåœ‹ç±</span>
            <span :class="characterCreationState.selectedNationality ? 'text-green-500' : 'text-red-500'">
              {{ characterCreationState.selectedNationality ? 'âœ“' : 'âœ—' }}
            </span>
          </div>
          <div class="text-xs text-gray-600">
            {{ characterCreationState.selectedNationality ? characterCreationState.selectedNationality.name : 'æœªé¸æ“‡åœ‹ç±' }}
          </div>
        </div>
        
        <div :class="characterCreationState.selectedBackground ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'" 
             class="p-3 rounded-lg border-2">
          <div class="flex items-center justify-between mb-1">
            <span class="text-sm font-medium">æ­¥é©Ÿ3ï¼šèƒŒæ™¯</span>
            <span :class="characterCreationState.selectedBackground ? 'text-green-500' : 'text-red-500'">
              {{ characterCreationState.selectedBackground ? 'âœ“' : 'âœ—' }}
            </span>
          </div>
          <div class="text-xs text-gray-600">
            {{ characterCreationState.selectedBackground ? characterCreationState.selectedBackground.name : 'æœªé¸æ“‡èƒŒæ™¯' }}
          </div>
        </div>
        
        <div :class="characterCreationState.selectedTrait ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'" 
             class="p-3 rounded-lg border-2">
          <div class="flex items-center justify-between mb-1">
            <span class="text-sm font-medium">æ­¥é©Ÿ4ï¼šç‰¹å¾µ</span>
            <span :class="characterCreationState.selectedTrait ? 'text-green-500' : 'text-red-500'">
              {{ characterCreationState.selectedTrait ? 'âœ“' : 'âœ—' }}
            </span>
          </div>
          <div class="text-xs text-gray-600">
            {{ characterCreationState.selectedTrait ? characterCreationState.selectedTrait.name : 'æœªé¸æ“‡ç‰¹å¾µ' }}
          </div>
        </div>
      </div>

      <!-- æª¢æŸ¥çµæœæ¦‚è¦½ -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
        <!-- çœŸç†æª¢æŸ¥ -->
        <div :class="truthCheckResult.isValid ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'" 
             class="p-4 rounded-lg border-2">
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-bold">çœŸç†</h4>
            <span :class="truthCheckResult.isValid ? 'text-green-500' : 'text-red-500'" class="text-xl">
              {{ truthCheckResult.isValid ? 'âœ“' : 'âœ—' }}
            </span>
          </div>
          <p class="text-sm">{{ truthCheckResult.current }}/{{ truthCheckResult.required }}</p>
          <p class="text-xs text-gray-600">{{ truthCheckResult.message }}</p>
        </div>

        <!-- å±¬æ€§æª¢æŸ¥ -->
        <div :class="attributeCheckResult.isValid ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'" 
             class="p-4 rounded-lg border-2">
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-bold">å±¬æ€§</h4>
            <span :class="attributeCheckResult.isValid ? 'text-green-500' : 'text-red-500'" class="text-xl">
              {{ attributeCheckResult.isValid ? 'âœ“' : 'âœ—' }}
            </span>
          </div>
          <p class="text-sm">ç¸½å’Œ: {{ attributeCheckResult.total }}/51</p>
          <p class="text-xs text-gray-600">{{ attributeCheckResult.message }}</p>
        </div>

        <!-- æŠ€èƒ½æª¢æŸ¥ -->
        <div :class="skillCheckResult.isValid ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'" 
             class="p-4 rounded-lg border-2">
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-bold">æŠ€èƒ½</h4>
            <span :class="skillCheckResult.isValid ? 'text-green-500' : 'text-red-500'" class="text-xl">
              {{ skillCheckResult.isValid ? 'âœ“' : 'âœ—' }}
            </span>
          </div>
          <p class="text-sm">ç¸½å’Œ: {{ skillCheckResult.total }}/{{ skillCheckResult.expected }}</p>
          <p class="text-xs text-gray-600">{{ skillCheckResult.message }}</p>
        </div>

        <!-- å°ˆç²¾æª¢æŸ¥ -->
        <div :class="focusCheckResult.isValid ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'" 
             class="p-4 rounded-lg border-2">
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-bold">å°ˆç²¾</h4>
            <span :class="focusCheckResult.isValid ? 'text-green-500' : 'text-red-500'" class="text-xl">
              {{ focusCheckResult.isValid ? 'âœ“' : 'âœ—' }}
            </span>
          </div>
          <p class="text-sm">{{ focusCheckResult.current }}/{{ focusCheckResult.required }}</p>
          <p class="text-xs text-gray-600">{{ focusCheckResult.message }}</p>
        </div>

        <!-- å¤©è³¦æª¢æŸ¥ -->
        <div :class="talentCheckResult.isValid ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'" 
             class="p-4 rounded-lg border-2">
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-bold">å¤©è³¦</h4>
            <span :class="talentCheckResult.isValid ? 'text-green-500' : 'text-red-500'" class="text-xl">
              {{ talentCheckResult.isValid ? 'âœ“' : 'âœ—' }}
            </span>
          </div>
          <p class="text-sm">{{ talentCheckResult.current }}/{{ talentCheckResult.required }}</p>
          <p class="text-xs text-gray-600">{{ talentCheckResult.message }}</p>
        </div>

        <!-- æ•´é«”ç‹€æ…‹ -->
        <div :class="allChecksValid ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'" 
             class="p-4 rounded-lg border-2">
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-bold">æ•´é«”ç‹€æ…‹</h4>
            <span :class="allChecksValid ? 'text-green-500' : 'text-amber-500'" class="text-xl">
              {{ allChecksValid ? 'âœ“' : 'âš ' }}
            </span>
          </div>
          <p class="text-sm">{{ allChecksValid ? 'æº–å‚™å®Œæˆ' : 'éœ€è¦æª¢æŸ¥' }}</p>
          <p class="text-xs text-gray-600">{{ allChecksValid ? 'æ‰€æœ‰é …ç›®å·²é€šéé©—è­‰' : 'è«‹æª¢æŸ¥ä¸Šè¿°é …ç›®' }}</p>
        </div>
        
        <!-- ç¼ºå¤±é …ç›®æ‘˜è¦ -->
        <div v-if="!allChecksValid" class="col-span-full">
          <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
            <h5 class="font-bold text-amber-800 mb-2">âš ï¸ éœ€è¦æ³¨æ„çš„é …ç›®ï¼š</h5>
            <ul class="text-sm text-amber-700 space-y-1">
              <li v-if="!characterCreationState.selectedArchetype">â€¢ è«‹å›åˆ°æ­¥é©Ÿ1é¸æ“‡åŸå‹</li>
              <li v-if="!characterCreationState.selectedNationality">â€¢ è«‹å›åˆ°æ­¥é©Ÿ2é¸æ“‡åœ‹ç±</li>
              <li v-if="!characterCreationState.selectedBackground">â€¢ è«‹å›åˆ°æ­¥é©Ÿ3é¸æ“‡èƒŒæ™¯</li>
              <li v-if="!characterCreationState.selectedTrait">â€¢ è«‹å›åˆ°æ­¥é©Ÿ4é¸æ“‡ç‰¹å¾µ</li>
              <li v-if="!truthCheckResult.isValid">â€¢ {{ truthCheckResult.message }}</li>
              <li v-if="!attributeCheckResult.isValid">â€¢ {{ attributeCheckResult.message }}</li>
              <li v-if="!skillCheckResult.isValid">â€¢ {{ skillCheckResult.message }}</li>
              <li v-if="!focusCheckResult.isValid">â€¢ {{ focusCheckResult.message }}</li>
              <li v-if="!talentCheckResult.isValid">â€¢ {{ talentCheckResult.message }}</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- è§’è‰²åç¨±è¨­å®š -->
    <div class="mb-8">
      <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ‘¤ è§’è‰²åç¨±</h3>
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <div class="max-w-md">
          <label for="characterName" class="block text-sm font-medium text-gray-700 mb-2">
            è§’è‰²åç¨±
          </label>
          <input
            id="characterName"
            v-model="characterName"
            type="text"
            placeholder="è«‹è¼¸å…¥è§’è‰²åç¨±"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
          />
          <p class="text-xs text-gray-500 mt-1">é€™å°‡æˆç‚ºæ‚¨è§’è‰²è¡¨ä¸Šçš„åç¨±</p>
        </div>
      </div>
    </div>

    <!-- è¨ˆç®—çš„æœ€çµ‚å±¬æ€§ -->
    <div class="mb-8">
      <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ§® è¨ˆç®—çµæœ</h3>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- åŸºç¤å±¬æ€§ -->
        <div class="bg-white rounded-lg p-6 border border-gray-200">
          <h4 class="text-lg font-semibold text-gray-800 mb-4">åŸºç¤å±¬æ€§</h4>
          <div class="space-y-2">
            <div v-for="(value, attr) in finalAttributes" :key="attr" 
                 class="flex justify-between items-center py-2 border-b border-gray-100">
              <span class="font-medium">{{ getAttributeName(attr) }}</span>
              <div class="flex items-center gap-2">
                <span class="text-lg font-bold text-blue-600">{{ value }}</span>
                <span v-if="getAttributeBonus(attr) > 0" class="text-xs text-green-600">
                  (+{{ getAttributeBonus(attr) }})
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- è¨ˆç®—çš„è¡ç”Ÿæ•¸å€¼ -->
        <div class="bg-white rounded-lg p-6 border border-gray-200">
          <h4 class="text-lg font-semibold text-gray-800 mb-4">è¡ç”Ÿæ•¸å€¼</h4>
          <div class="space-y-3">
            <!-- å£“åŠ›è»Œ -->
            <div class="flex justify-between items-center py-2 border-b border-gray-100">
              <span class="font-medium">å£“åŠ›å€¼</span>
              <span class="text-lg font-bold text-purple-600">{{ calculatedStress }}</span>
            </div>
            
            <!-- è­·ç”²æŠ—æ€§ -->
            <div class="flex justify-between items-center py-2 border-b border-gray-100">
              <span class="font-medium">è­·ç”²æŠ—æ€§</span>
              <span class="text-lg font-bold text-orange-600">{{ calculatedArmorResistance }}</span>
            </div>
            
            <!-- å‹‡æ°£æŠ—æ€§ -->
            <div class="flex justify-between items-center py-2 border-b border-gray-100">
              <span class="font-medium">å‹‡æ°£æŠ—æ€§</span>
              <span class="text-lg font-bold text-green-600">{{ calculatedCourageResistance }}</span>
            </div>
            
            <!-- é¡å¤–èªè¨€ -->
            <div class="flex justify-between items-center py-2 border-b border-gray-100">
              <span class="font-medium">é¡å¤–èªè¨€æ•¸</span>
              <span class="text-lg font-bold text-blue-600">{{ calculatedBonusLanguages }}</span>
            </div>
            
            <!-- æŒ‘æˆ°éª°åŠ æˆ -->
            <div class="py-2">
              <span class="font-medium block mb-2">æŒ‘æˆ°éª°åŠ æˆ</span>
              <div class="space-y-1 text-sm">
                <div class="flex justify-between">
                  <span>è¿‘æˆ° (é«”é­„):</span>
                  <span class="font-bold">+{{ getBonusChallengeDice('BRA') }}ğŸ²</span>
                </div>
                <div class="flex justify-between">
                  <span>é ç¨‹ (æ´å¯Ÿ):</span>
                  <span class="font-bold">+{{ getBonusChallengeDice('INS') }}ğŸ²</span>
                </div>
                <div class="flex justify-between">
                  <span>é­”æ³• (æ„å¿—):</span>
                  <span class="font-bold">+{{ getBonusChallengeDice('WIL') }}ğŸ²</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- é­”æ³•èƒ½åŠ›æª¢æŸ¥ -->
    <div v-if="isMagicUser" class="mb-8">
      <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ”® é­”æ³•èƒ½åŠ›</h3>
      <div class="bg-purple-50 border border-purple-200 rounded-lg p-6">
        <div class="flex items-center gap-3 mb-4">
          <span class="text-2xl">ğŸ§™â€â™‚ï¸</span>
          <div>
            <h4 class="text-lg font-semibold text-purple-800">æª¢æ¸¬åˆ°æ–½æ³•è€…èƒ½åŠ›</h4>
            <p class="text-sm text-purple-600">{{ magicUserInfo.description }}</p>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="text-center p-3 bg-white rounded-lg">
            <div class="text-sm text-gray-600 mb-1">æ–½æ³•é¡å‹</div>
            <div class="font-bold text-purple-800">{{ magicUserInfo.type }}</div>
          </div>
          <div class="text-center p-3 bg-white rounded-lg">
            <div class="text-sm text-gray-600 mb-1">æ–½æ³•å±¬æ€§</div>
            <div class="font-bold text-purple-800">{{ magicUserInfo.attribute }}</div>
          </div>
          <div class="text-center p-3 bg-white rounded-lg">
            <div class="text-sm text-gray-600 mb-1">åŸºç¤å¨èƒ½</div>
            <div class="font-bold text-purple-800">{{ magicUserInfo.basePower }}ğŸ²</div>
          </div>
        </div>
        
        <div v-if="magicUserInfo.spellCount" class="mt-4">
          <p class="text-sm text-purple-700">
            <strong>åˆå§‹æ³•è¡“:</strong> å¯å­¸ç¿’ {{ magicUserInfo.spellCount }} é …æ³•è¡“
            <span v-if="magicUserInfo.tradition">ï¼ˆé™{{ magicUserInfo.tradition }}å‚³çµ±ï¼‰</span>
          </p>
        </div>
      </div>
    </div>

    <!-- è§’è‰²æ‘˜è¦ -->
    <div class="mb-8">
      <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“‹ è§’è‰²æ‘˜è¦</h3>
      <div class="bg-gray-50 rounded-lg p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h4 class="font-semibold text-gray-800 mb-3">åŸºæœ¬è³‡è¨Š</h4>
            <div class="space-y-2 text-sm">
              <div><strong>åŸå‹:</strong> {{ characterCreationState.selectedArchetype?.chineseName || characterCreationState.selectedArchetype?.name || 'æœªé¸æ“‡' }}</div>
              <div><strong>åœ‹ç±:</strong> {{ characterCreationState.selectedNationality?.chineseName || characterCreationState.selectedNationality?.name || 'æœªé¸æ“‡' }}</div>
              <div><strong>èƒŒæ™¯:</strong> {{ characterCreationState.selectedBackground?.chineseName || characterCreationState.selectedBackground?.name || 'æœªé¸æ“‡' }}</div>
              <div><strong>ç‰¹å¾µ:</strong> {{ characterCreationState.selectedTrait?.chineseName || characterCreationState.selectedTrait?.name || 'æœªé¸æ“‡' }}</div>
            </div>
          </div>
          
          <div>
            <h4 class="font-semibold text-gray-800 mb-3">é¸æ“‡çµ±è¨ˆ</h4>
            <div class="space-y-2 text-sm">
              <div><strong>çœŸç†æ•¸é‡:</strong> {{ truthCount }} é …</div>
              <div><strong>å°ˆç²¾æ•¸é‡:</strong> {{ focusCount }} é …</div>
              <div><strong>å¤©è³¦æ•¸é‡:</strong> {{ talentCount }} é …</div>
              <div><strong>æŠ€èƒ½ç¸½é»æ•¸:</strong> {{ skillTotal }} é»</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- è­¦å‘Šå’Œå»ºè­° -->
    <div v-if="!allChecksValid" class="mb-8">
      <h3 class="text-xl font-bold text-red-600 mb-4">âš ï¸ éœ€è¦æ³¨æ„çš„å•é¡Œ</h3>
      <div class="space-y-3">
        <div v-if="!truthCheckResult.isValid" class="bg-red-50 border border-red-200 rounded-lg p-4">
          <h4 class="font-semibold text-red-800 mb-2">çœŸç†ä¸è¶³</h4>
          <p class="text-sm text-red-700">{{ truthCheckResult.message }}</p>
          <p class="text-xs text-red-600 mt-1">è«‹è¿”å›å‰é¢çš„æ­¥é©Ÿç¢ºèªçœŸç†é¸æ“‡ã€‚</p>
        </div>
        
        <div v-if="!attributeCheckResult.isValid" class="bg-red-50 border border-red-200 rounded-lg p-4">
          <h4 class="font-semibold text-red-800 mb-2">å±¬æ€§å•é¡Œ</h4>
          <p class="text-sm text-red-700">{{ attributeCheckResult.message }}</p>
          <p class="text-xs text-red-600 mt-1">è«‹æª¢æŸ¥å±¬æ€§åˆ†é…æ˜¯å¦æ­£ç¢ºã€‚</p>
        </div>
        
        <div v-if="!skillCheckResult.isValid" class="bg-red-50 border border-red-200 rounded-lg p-4">
          <h4 class="font-semibold text-red-800 mb-2">æŠ€èƒ½å•é¡Œ</h4>
          <p class="text-sm text-red-700">{{ skillCheckResult.message }}</p>
          <p class="text-xs text-red-600 mt-1">è«‹æª¢æŸ¥æŠ€èƒ½é»æ•¸åˆ†é…ã€‚</p>
        </div>
        
        <div v-if="!focusCheckResult.isValid" class="bg-red-50 border border-red-200 rounded-lg p-4">
          <h4 class="font-semibold text-red-800 mb-2">å°ˆç²¾ä¸è¶³</h4>
          <p class="text-sm text-red-700">{{ focusCheckResult.message }}</p>
          <p class="text-xs text-red-600 mt-1">è«‹è¿”å›åŸå‹å’ŒèƒŒæ™¯æ­¥é©Ÿç¢ºèªå°ˆç²¾é¸æ“‡ã€‚</p>
        </div>
        
        <div v-if="!talentCheckResult.isValid" class="bg-red-50 border border-red-200 rounded-lg p-4">
          <h4 class="font-semibold text-red-800 mb-2">å¤©è³¦ä¸è¶³</h4>
          <p class="text-sm text-red-700">{{ talentCheckResult.message }}</p>
          <p class="text-xs text-red-600 mt-1">è«‹è¿”å›å„æ­¥é©Ÿç¢ºèªå¤©è³¦é¸æ“‡ã€‚</p>
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨å°èˆª -->
    <div class="flex justify-between">
      <button 
        @click="$emit('prev-step')"
        class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors"
      >
        ä¸Šä¸€æ­¥
      </button>
      <button 
        @click="finishCharacterCreation"
        :disabled="!allChecksValid"
        :class="[
          'px-6 py-2 rounded-lg transition-colors font-bold',
          allChecksValid
            ? 'bg-green-600 text-white hover:bg-green-700'
            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
        ]"
      >
        {{ allChecksValid ? 'å®Œæˆè§’è‰²å»ºç«‹' : 'è«‹å…ˆä¿®æ­£å•é¡Œ' }}
      </button>
    </div>
  </div>
</template>

<script setup>
import { computed, inject, ref } from 'vue'
import { useAchtungCthulhuStore } from '~/stores/achtungCthulhuStore'

const props = defineProps({
  characterData: {
    type: Object,
    default: () => ({})
  }
})

const emit = defineEmits(['finish-creation', 'prev-step'])

// ä½¿ç”¨ Pinia store
const store = useAchtungCthulhuStore()

// ä½¿ç”¨å…¨å±€ç‹€æ…‹
const characterCreationState = inject('characterCreationState')

// è§’è‰²åç¨±
const characterName = ref('')

// åŸºç¤æ•¸å€¼è¨ˆç®—
const baseAttributes = {
  AGI: 6, BRA: 6, COO: 6, INS: 6, REA: 6, WIL: 6
}

// è¨ˆç®—æœ€çµ‚å±¬æ€§
const finalAttributes = computed(() => {
  const attributes = { ...baseAttributes }
  
  // ä¾†è‡ªåŸå‹çš„å±¬æ€§åŠ æˆ
  if (characterCreationState.value.selectedArchetype?.attributeBonus) {
    Object.entries(characterCreationState.value.selectedArchetype.attributeBonus).forEach(([attr, bonus]) => {
      attributes[attr] += bonus
    })
  }
  
  // ä¾†è‡ªåœ‹ç±çš„å±¬æ€§åŠ æˆ
  if (characterCreationState.value.selectedNationality?.attributeBonus) {
    Object.entries(characterCreationState.value.selectedNationality.attributeBonus).forEach(([attr, bonus]) => {
      attributes[attr] += bonus
    })
  }
  
  // ä¾†è‡ªèƒŒæ™¯çš„å±¬æ€§åŠ æˆ
  if (characterCreationState.value.selectedBackground?.attributeBonus) {
    Object.entries(characterCreationState.value.selectedBackground.attributeBonus).forEach(([attr, bonus]) => {
      attributes[attr] += bonus
    })
  }
  
  // ä¾†è‡ªç‰¹å¾µçš„å±¬æ€§åŠ æˆ
  if (characterCreationState.value.selectedTrait?.attributeBonus) {
    Object.entries(characterCreationState.value.selectedTrait.attributeBonus).forEach(([attr, bonus]) => {
      attributes[attr] += bonus
    })
  }
  
  // ä¾†è‡ªé¸æ“‡çš„å½ˆæ€§å±¬æ€§åŠ æˆ
  if (characterCreationState.value.traitSelections?.flexibleAttribute) {
    const flexAttr = characterCreationState.value.traitSelections.flexibleAttribute
    if (characterCreationState.value.selectedTrait?.flexibleAttributePoints) {
      attributes[flexAttr] += characterCreationState.value.selectedTrait.flexibleAttributePoints
    }
  }
  
  return attributes
})

// ç²å–å±¬æ€§åŠ æˆï¼ˆç”¨æ–¼é¡¯ç¤ºï¼‰
const getAttributeBonus = (attrCode) => {
  const base = baseAttributes[attrCode]
  const final = finalAttributes.value[attrCode]
  return final - base
}

// è¨ˆç®—ç¸½å±¬æ€§é»æ•¸
const totalAttributePoints = computed(() => {
  return Object.values(finalAttributes.value).reduce((sum, value) => sum + value, 0)
})

// è¨ˆç®—æœ€çµ‚æŠ€èƒ½é»æ•¸
const finalSkills = computed(() => {
  const skills = {
    ACADEMIA: 0, ATHLETICS: 0, COMMAND: 0, ENGINEERING: 0,
    FIGHTING: 0, MEDICINE: 0, OBSERVATION: 0, PERSUASION: 0,
    RESILIENCE: 0, STEALTH: 0, SURVIVAL: 0, TACTICS: 0, VEHICLES: 0
  }
  
  // ä¾†è‡ªåŸå‹çš„æŠ€èƒ½åŠ æˆ
  if (characterCreationState.value.selectedArchetype?.skillBonus) {
    Object.entries(characterCreationState.value.selectedArchetype.skillBonus).forEach(([skill, bonus]) => {
      skills[skill] += bonus
    })
  }
  
  // ä¾†è‡ªåœ‹ç±çš„æŠ€èƒ½åŠ æˆ
  if (characterCreationState.value.selectedNationality?.skillBonus) {
    Object.entries(characterCreationState.value.selectedNationality.skillBonus).forEach(([skill, bonus]) => {
      skills[skill] += bonus
    })
  }
  
  // ä¾†è‡ªèƒŒæ™¯çš„æŠ€èƒ½åŠ æˆ
  if (characterCreationState.value.selectedBackground?.skillBonus) {
    Object.entries(characterCreationState.value.selectedBackground.skillBonus).forEach(([skill, bonus]) => {
      skills[skill] += bonus
    })
  }
  
  // ä¾†è‡ªç‰¹å¾µçš„æŠ€èƒ½åŠ æˆ
  if (characterCreationState.value.selectedTrait?.skillBonus) {
    Object.entries(characterCreationState.value.selectedTrait.skillBonus).forEach(([skill, bonus]) => {
      skills[skill] += bonus
    })
  }
  
  // ä¾†è‡ªç‰¹å¾µçš„å½ˆæ€§æŠ€èƒ½é¸æ“‡
  if (characterCreationState.value.traitSelections?.flexibleSkills) {
    const flexSkills = characterCreationState.value.traitSelections.flexibleSkills
    const points = characterCreationState.value.selectedTrait?.flexibleSkillPoints || 1
    flexSkills.forEach(skill => {
      skills[skill] += points
    })
  }
  
  // ä¾†è‡ªç‰¹å¾µçš„ç‰¹æ®ŠæŠ€èƒ½é¸æ“‡
  if (characterCreationState.value.traitSelections?.specialSkill) {
    skills[characterCreationState.value.traitSelections.specialSkill] += 1
  }
  
  // è™•ç†ç‰¹æ®Šè¦å‰‡
  if (characterCreationState.value.selectedTrait?.specialSkillRule === 'all-zero-skills') {
    // åšå­¸å¤šèƒ½è€…ï¼šæ‰€æœ‰0ç´šæŠ€èƒ½+1
    Object.keys(skills).forEach(skill => {
      if (skills[skill] === 0) {
        skills[skill] += 1
      }
    })
  }
  
  return skills
})

// è¨ˆç®—æŠ€èƒ½ç¸½é»æ•¸
const skillTotal = computed(() => {
  return Object.values(finalSkills.value).reduce((sum, value) => sum + value, 0)
})

// è¨ˆç®—å°ˆç²¾æ•¸é‡
const focusCount = computed(() => {
  let count = 0
  
  // ä¾†è‡ªåŸå‹çš„å°ˆç²¾
  if (characterCreationState.value.archetypeSelections?.selectedFocuses) {
    count += characterCreationState.value.archetypeSelections.selectedFocuses.length
  }
  
  // ä¾†è‡ªèƒŒæ™¯çš„å°ˆç²¾
  if (characterCreationState.value.backgroundSelections?.selectedFocuses) {
    count += characterCreationState.value.backgroundSelections.selectedFocuses.length
  }
  
  // ä¾†è‡ªç‰¹å¾µçš„å°ˆç²¾
  if (characterCreationState.value.traitSelections?.selectedFocuses) {
    count += characterCreationState.value.traitSelections.selectedFocuses.length
  }
  
  return count
})

// è¨ˆç®—å¤©è³¦æ•¸é‡
const talentCount = computed(() => {
  let count = 0
  
  // åŸå‹å¤©è³¦
  if (characterCreationState.value.archetypeSelections?.selectedTalent) count++
  
  // èƒŒæ™¯å¤©è³¦
  if (characterCreationState.value.backgroundSelections?.selectedTalent) count++
  
  // ç‰¹å¾µå¤©è³¦
  if (characterCreationState.value.traitSelections?.talent) count++
  
  return count
})

// è¨ˆç®—çœŸç†æ•¸é‡
const truthCount = computed(() => {
  let count = 0
  
  // åœ‹ç±çœŸç†ï¼ˆåœ‹ç±æœ¬èº«å°±æ˜¯çœŸç†ï¼‰
  if (characterCreationState.value.selectedNationality) count++
  
  // èªè¨€çœŸç†ï¼ˆåœ‹ç±é¸æ“‡çš„èªè¨€ï¼‰
  if (characterCreationState.value.nationalitySelections?.selectedLanguage) count++
  
  // èƒŒæ™¯çœŸç†
  if (characterCreationState.value.backgroundSelections?.selectedTruth) count++
  
  // ç‰¹å¾µçœŸç†
  if (characterCreationState.value.traitSelections?.truth) count++
  
  return count
})

// æª¢æŸ¥æ˜¯å¦ç‚ºæ–½æ³•è€…
const isMagicUser = computed(() => {
  // æª¢æŸ¥æ˜¯å¦ç‚ºç¥ç§˜å­¸è€…åŸå‹ä¸”æœ‰æ–½æ³•è€…å¤©è³¦
  const isOccultArchetype = characterCreationState.value.selectedArchetype?.key === 'occult-scholar'
  if (!isOccultArchetype) return false
  
  // æª¢æŸ¥é¸æ“‡çš„å¤©è³¦æ˜¯å¦æœ‰æ–½æ³•è€…é—œéµè©
  const selectedTalents = [
    characterCreationState.value.archetypeSelections?.selectedTalent,
    characterCreationState.value.backgroundSelections?.selectedTalent,
    characterCreationState.value.traitSelections?.talent
  ].filter(Boolean)
  
  return selectedTalents.some(talent => 
    talent.keywords && talent.keywords.includes('æ–½æ³•è€…')
  )
})

// é­”æ³•ä½¿ç”¨è€…è³‡è¨Š
const magicUserInfo = computed(() => {
  if (!isMagicUser.value) return null
  
  // æ ¹æ“šå¤©è³¦æˆ–èƒŒæ™¯åˆ¤æ–·æ–½æ³•é¡å‹
  const selectedTalent = characterCreationState.value.archetypeSelections?.selectedTalent ||
                          characterCreationState.value.backgroundSelections?.selectedTalent ||
                          characterCreationState.value.traitSelections?.talent
  
  // é è¨­ç‚ºç ”ç©¶è€…é¡å‹
  return {
    type: 'ç ”ç©¶è€…',
    attribute: 'æ™ºè­˜ (Reason)',
    basePower: 2,
    spellCount: 2,
    description: 'é€éåš´è¬¹çš„å­¸è¡“é€”å¾‘ç¿’å¾—é­”æ³•ï¼Œé•·å¹´é‘½ç ”å¤ç±èˆ‡ç¦æ›¸'
  }
})

// è¨ˆç®—è¡ç”Ÿæ•¸å€¼
const calculatedStress = computed(() => {
  const brawn = finalAttributes.value.BRA
  const will = finalAttributes.value.WIL
  const resilience = finalSkills.value.RESILIENCE
  
  return Math.max(brawn, will) + resilience
})

const calculatedArmorResistance = computed(() => {
  const brawn = finalAttributes.value.BRA
  if (brawn <= 8) return 0
  if (brawn === 9) return 1
  if (brawn <= 11) return 2
  if (brawn <= 13) return 3
  if (brawn <= 15) return 4
  return 5
})

const calculatedCourageResistance = computed(() => {
  const will = finalAttributes.value.WIL
  if (will <= 8) return 0
  if (will === 9) return 1
  if (will <= 11) return 2
  if (will <= 13) return 3
  if (will <= 15) return 4
  return 5
})

const calculatedBonusLanguages = computed(() => {
  const reason = finalAttributes.value.REA
  if (reason <= 10) return 1
  return 2
})

const getBonusChallengeDice = (attrCode) => {
  const value = finalAttributes.value[attrCode]
  if (value <= 8) return 0
  if (value === 9) return 1
  if (value <= 11) return 2
  if (value <= 13) return 3
  if (value <= 15) return 4
  return 5
}

// æ•¸å€¼æª¢æŸ¥
const truthCheckResult = computed(() => {
  const required = 4
  const current = truthCount.value
  const isValid = current >= required
  
  return {
    isValid,
    current,
    required,
    message: isValid 
      ? 'çœŸç†æ•¸é‡ç¬¦åˆè¦æ±‚' 
      : `ç¼ºå°‘ ${required - current} é …çœŸç†ï¼ˆèƒŒæ™¯ã€ç‰¹å¾µã€åœ‹ç±ã€èªè¨€å„ä¸€é …ï¼‰`
  }
})

// å„æ­¥é©Ÿè²¢ç»åˆ†æ
const archetypeContribution = computed(() => {
  const archetype = characterCreationState.value.selectedArchetype
  const selections = characterCreationState.value.archetypeSelections
  
  if (!archetype) {
    return { talents: [], focuses: [], attributes: [], skills: [], truths: [] }
  }
  
  const talents = []
  
  // åŸå‹è‡ªå¸¶çš„å¤©è³¦ï¼ˆå¦‚æœæœ‰ï¼‰
  if (archetype.talents) {
    talents.push(...archetype.talents.map(t => t.chineseName || t.name))
  }
  
  // åŸå‹é¸æ“‡çš„å¤©è³¦
  if (selections?.selectedTalent) {
    talents.push(selections.selectedTalent.chineseName || selections.selectedTalent.name)
  }
  
  return {
    talents,
    focuses: selections?.selectedFocuses || [],
    attributes: Object.entries(archetype.attributeBonus || {}).map(([attr, bonus]) => `${attr}+${bonus}`),
    skills: Object.entries(archetype.skillBonus || {}).map(([skill, bonus]) => `${skill}+${bonus}`),
    truths: []
  }
})

const nationalityContribution = computed(() => {
  const nationality = characterCreationState.value.selectedNationality
  const selections = characterCreationState.value.nationalitySelections
  
  if (!nationality) {
    return { talents: [], focuses: [], attributes: [], skills: [], truths: [], languages: [] }
  }
  
  const truths = [nationality.name] // åœ‹ç±ä½œç‚ºçœŸç†
  if (selections?.selectedLanguage) {
    truths.push(selections.selectedLanguage) // é¸æ“‡çš„èªè¨€ä½œç‚ºçœŸç†
  } else if (nationality.languages?.length === 1) {
    truths.push(nationality.languages[0]) // å–®ä¸€èªè¨€è‡ªå‹•ä½œç‚ºçœŸç†
  }
  
  return {
    talents: [],
    focuses: [],
    attributes: Object.entries(nationality.attributeBonus || {}).map(([attr, bonus]) => `${attr}+${bonus}`),
    skills: Object.entries(nationality.skillBonus || {}).map(([skill, bonus]) => `${skill}+${bonus}`),
    truths,
    languages: nationality.languages || []
  }
})

const backgroundContribution = computed(() => {
  const background = characterCreationState.value.selectedBackground
  const selections = characterCreationState.value.backgroundSelections
  
  if (!background) {
    return { talents: [], focuses: [], attributes: [], skills: [], truths: [] }
  }
  
  const truths = selections?.selectedTruths || []
  const talents = []
  
  // èƒŒæ™¯æä¾›çš„å¤©è³¦
  if (background.talents) {
    talents.push(...background.talents.map(t => t.name))
  }
  
  // èƒŒæ™¯é¸æ“‡çš„å¤©è³¦
  if (selections?.selectedTalent) {
    talents.push(selections.selectedTalent.chineseName || selections.selectedTalent.name)
  }
  
  const attributes = []
  const skills = []
  
  // èƒŒæ™¯çš„å±¬æ€§/æŠ€èƒ½åŠ æˆ
  if (background.attributeBonus) {
    attributes.push(...Object.entries(background.attributeBonus).map(([attr, bonus]) => `${attr}+${bonus}`))
  }
  if (background.skillBonus) {
    skills.push(...Object.entries(background.skillBonus).map(([skill, bonus]) => `${skill}+${bonus}`))
  }
  
  // èƒŒæ™¯é¸æ“‡çš„å½ˆæ€§å±¬æ€§/æŠ€èƒ½
  if (selections?.flexibleAttributes) {
    attributes.push(...selections.flexibleAttributes.map(attr => `${attr}+1`))
  }
  if (selections?.flexibleSkills) {
    skills.push(...selections.flexibleSkills.map(skill => `${skill}+1`))
  }
  
  return {
    talents,
    focuses: (selections?.selectedFocuses || []).map(focus => 
      typeof focus === 'object' ? focus.name : focus
    ),
    attributes,
    skills,
    truths
  }
})

const traitContribution = computed(() => {
  const trait = characterCreationState.value.selectedTrait
  const selections = characterCreationState.value.traitSelections
  
  if (!trait) {
    return { talents: [], focuses: [], attributes: [], skills: [], truths: [] }
  }
  
  const truths = selections?.selectedTruths || []
  const talents = []
  const focuses = []
  const attributes = []
  const skills = []
  
  // ç‰¹å¾µæä¾›çš„å¤©è³¦
  if (trait.talents) {
    talents.push(...trait.talents.map(t => t.name))
  }
  
  // ç‰¹å¾µé¸æ“‡çš„å¤©è³¦
  if (selections?.talent) {
    talents.push(selections.talent.chineseName || selections.talent.name)
  }
  
  // ç‰¹å¾µæä¾›çš„å°ˆç²¾
  if (trait.focuses) {
    focuses.push(...trait.focuses)
  }
  
  // ç‰¹å¾µé¸æ“‡çš„å°ˆç²¾
  if (selections?.selectedFocuses) {
    focuses.push(...selections.selectedFocuses.map(focus => 
      typeof focus === 'object' ? focus.name : focus
    ))
  }
  
  // ç‰¹å¾µçš„å±¬æ€§åŠ æˆ
  if (trait.attributeBonus) {
    attributes.push(...Object.entries(trait.attributeBonus).map(([attr, bonus]) => `${attr}+${bonus}`))
  }
  
  // ç‰¹å¾µçš„æŠ€èƒ½åŠ æˆ
  if (trait.skillBonus) {
    skills.push(...Object.entries(trait.skillBonus).map(([skill, bonus]) => `${skill}+${bonus}`))
  }
  
  // ç‰¹å¾µé¸æ“‡çš„å½ˆæ€§å±¬æ€§/æŠ€èƒ½
  if (selections?.flexibleAttributes) {
    attributes.push(...selections.flexibleAttributes.map(attr => `${attr}+${trait.flexibleAttributePoints || 1}`))
  }
  if (selections?.flexibleSkills) {
    skills.push(...selections.flexibleSkills.map(skill => `${skill}+${trait.flexibleSkillPoints || 1}`))
  }
  
  // ç‰¹æ®ŠæŠ€èƒ½é¸æ“‡
  if (selections?.specialSkill) {
    skills.push(`${selections.specialSkill}+1`)
  }
  
  return {
    talents,
    focuses,
    attributes,
    skills,
    truths
  }
})

const attributeCheckResult = computed(() => {
  const total = totalAttributePoints.value
  const isValid = total === 51 && Object.values(finalAttributes.value).every(val => val >= 6 && val <= 11)
  
  return {
    isValid,
    total,
    message: total !== 51 
      ? `å±¬æ€§ç¸½å’Œæ‡‰ç‚º51ï¼Œç›®å‰ç‚º${total}` 
      : Object.values(finalAttributes.value).some(val => val < 6 || val > 11)
        ? 'æ‰€æœ‰å±¬æ€§æ‡‰ä»‹æ–¼6-11ä¹‹é–“'
        : 'å±¬æ€§åˆ†é…æ­£ç¢º'
  }
})

const skillCheckResult = computed(() => {
  const total = skillTotal.value
  const isDilettante = characterCreationState.value.selectedTrait?.key === 'dilettante'
  const expected = isDilettante ? '17+' : 17
  const isValid = isDilettante ? total >= 17 : total === 17
  const maxSkillValid = Object.values(finalSkills.value).every(val => val <= 5)
  
  return {
    isValid: isValid && maxSkillValid,
    total,
    expected,
    message: !maxSkillValid 
      ? 'æŠ€èƒ½ç­‰ç´šä¸å¾—è¶…é5'
      : isValid 
        ? 'æŠ€èƒ½é»æ•¸åˆ†é…æ­£ç¢º' 
        : `æŠ€èƒ½ç¸½å’Œæ‡‰ç‚º${expected}ï¼Œç›®å‰ç‚º${total}`
  }
})

const focusCheckResult = computed(() => {
  // åŸºæœ¬è¦æ±‚ï¼šåŸå‹2é …ã€èƒŒæ™¯2é …ï¼Œç¸½å…±4é …
  let required = 4
  let current = focusCount.value
  
  // æª¢æŸ¥ç‰¹å¾µæ˜¯å¦æä¾›é¡å¤–å°ˆç²¾
  if (characterCreationState.value.traitSelections?.selectedFocuses?.length > 0) {
    required += characterCreationState.value.traitSelections.selectedFocuses.length
  }
  
  const isValid = current >= 4 // è‡³å°‘è¦æœ‰åŸºæœ¬çš„4é …å°ˆç²¾
  
  return {
    isValid,
    current,
    required: 4, // é¡¯ç¤ºåŸºæœ¬è¦æ±‚
    message: isValid 
      ? `å°ˆç²¾æ•¸é‡ç¬¦åˆè¦æ±‚ (${current}é …)` 
      : `ç¼ºå°‘ ${4 - current} é …å°ˆç²¾ï¼ˆåŸå‹2é …ã€èƒŒæ™¯2é …ç‚ºåŸºæœ¬è¦æ±‚ï¼‰`
  }
})

const talentCheckResult = computed(() => {
  const required = 3
  const current = talentCount.value
  const isValid = current >= required
  
  return {
    isValid,
    current,
    required,
    message: isValid 
      ? 'å¤©è³¦æ•¸é‡ç¬¦åˆè¦æ±‚' 
      : `ç¼ºå°‘ ${required - current} é …å¤©è³¦ï¼ˆåŸå‹ã€èƒŒæ™¯ã€ç‰¹å¾µå„ä¸€é …ï¼‰`
  }
})

const allChecksValid = computed(() => {
  return truthCheckResult.value.isValid &&
         attributeCheckResult.value.isValid &&
         skillCheckResult.value.isValid &&
         focusCheckResult.value.isValid &&
         talentCheckResult.value.isValid
})

// è¼”åŠ©å‡½æ•¸
const getAttributeName = (attrCode) => {
  const names = {
    AGI: 'æ•æ·', BRA: 'é«”é­„', COO: 'å”èª¿',
    INS: 'æ´å¯Ÿ', REA: 'æ™ºè­˜', WIL: 'æ„å¿—'
  }
  return names[attrCode] || attrCode
}

// å®Œæˆè§’è‰²å‰µå»º
const finishCharacterCreation = () => {
  // æ§‹å»ºå®Œæ•´çš„è§’è‰²å‰µå»ºè³‡æ–™
  const finalCharacterData = {
    // åŸºæœ¬é¸æ“‡
    archetype: characterCreationState.value.selectedArchetype,
    nationality: characterCreationState.value.selectedNationality,
    background: characterCreationState.value.selectedBackground,
    trait: characterCreationState.value.selectedTrait,
    
    // è©³ç´°é¸æ“‡
    archetypeSelections: characterCreationState.value.archetypeSelections,
    nationalitySelections: characterCreationState.value.nationalitySelections,
    backgroundSelections: characterCreationState.value.backgroundSelections,
    traitSelections: characterCreationState.value.traitSelections,
    
    // è¨ˆç®—çµæœ
    finalAttributes: finalAttributes.value,
    finalSkills: finalSkills.value,
    calculatedValues: {
      stress: calculatedStress.value,
      armorResistance: calculatedArmorResistance.value,
      courageResistance: calculatedCourageResistance.value,
      bonusLanguages: calculatedBonusLanguages.value,
      bonusChallengeDice: {
        melee: getBonusChallengeDice('BRA'),
        ranged: getBonusChallengeDice('INS'),
        magic: getBonusChallengeDice('WIL')
      }
    },
    
    // é­”æ³•ä½¿ç”¨è€…è³‡è¨Š
    magicInfo: magicUserInfo.value,
    
    // é©—è­‰çµæœ
    validationResults: {
      truth: truthCheckResult.value,
      attributes: attributeCheckResult.value,
      skills: skillCheckResult.value,
      focuses: focusCheckResult.value,
      talents: talentCheckResult.value,
      allValid: allChecksValid.value
    }
  }
  
  // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰é©—è­‰éƒ½é€šé
  if (!allChecksValid.value) {
    alert('è«‹å…ˆå®Œæˆæ‰€æœ‰å¿…è¦çš„é¸æ“‡ä¸¦ç¢ºä¿æ•¸å€¼æ­£ç¢º')
    return
  }
  
  try {
    // è¨­å®šè§’è‰²åç¨±ï¼ˆå¦‚æœæœ‰æä¾›ï¼‰
    if (characterName.value.trim()) {
      store.setCharacterName(characterName.value.trim())
    }
    
    // æ‡‰ç”¨è§’è‰²å‰µå»ºè³‡æ–™åˆ° Pinia store
    store.applyCharacterCreationData(finalCharacterData)
    
    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
    alert('è§’è‰²å‰µå»ºå®Œæˆï¼æ‰€æœ‰è³‡æ–™å·²æ‡‰ç”¨åˆ°è§’è‰²è¡¨ã€‚')
    
    // ç™¼é€å®Œæˆäº‹ä»¶çµ¦çˆ¶çµ„ä»¶
    emit('finish-creation', finalCharacterData)
    
  } catch (error) {
    console.error('è§’è‰²å‰µå»ºæ‡‰ç”¨å¤±æ•—:', error)
    alert('è§’è‰²å‰µå»ºæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚')
  }
}
</script>